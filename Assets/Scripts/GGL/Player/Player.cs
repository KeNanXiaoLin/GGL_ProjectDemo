using System;
using System.Collections;
using System.Collections.Generic;
using KNXL.AutoGenerated.Data;
using UnityEngine;

public class Player : MonoBehaviour
{
    [SerializeField] private int nowCrazyValue = 5;
    [SerializeField] private int nowReasonValue = 0;
    [SerializeField] private float moveSpeed = 1.5f;
    [SerializeField] private SpriteRenderer spriteRenderer;
    [SerializeField] private SpriteRenderer soulSR;
    private LineRenderer lineRenderer;
    [SerializeField] private E_InputAction inputAction = E_InputAction.WASD;
    [SerializeField] private float startWidth = 0.05f;
    [SerializeField] private float endWidth = 0.1f;
    [SerializeField] private float leftX = -10f;
    [SerializeField] private float rightX = 10f;
    [SerializeField] private float bottomY = -5f;
    [SerializeField] private float topY = 5f;
    [SerializeField] private Texture2D cursor0;
    [SerializeField] private Texture2D cursor1;
    [SerializeField] private Texture2D cursor2;

    private CfgMaskData currentMaskData;
    private E_World currentWorldType => GameManager.Instance.CurrentWorldType;
    private float xInput, yInput;
    // 记录一个移动的开始位置，方便重置移动
    private Vector2 startMovePos = Vector2.zero;
    // 记录上次移动的位置
    private Vector2 lastMovePos;
    // 记录里世界上次鼠标的位置
    private Vector2 lastMousePos = Vector2.zero;
    // 记录目标单元格
    private Cell targetCell;
    // 记录上一个面具数据
    private CfgMaskData lastMaskData;
    private bool hasTargetMaskInRange = false;
    private bool isSave = false;
    private bool isPause = false;

    #region UI部分内容
    public GrayPanel grayPanel;
    public VerticalHealthBar verticalHealthBar;
    #endregion


    private void Awake()
    {
        lineRenderer = GetComponent<LineRenderer>();

    }

    private void Start()
    {
        currentMaskData = AbilityManager.Instance.GetAbilityData(10007);
        spriteRenderer.sprite = Resources.Load<Sprite>(currentMaskData.spritePath);
        nowCrazyValue = currentMaskData.startCrazy;
        nowReasonValue = currentMaskData.startLizi;
        lastMovePos = transform.position;
        transform.position = GameManager.Instance.playerPos;
    }

    private void Update()
    {
        if (isPause)
        {
            return;
        }
        if (Input.GetKeyDown(KeyCode.Space))
        {
            ChangeWorld();
        }
        DoInteract();

    }

    private void DoInteract()
    {
        switch (currentWorldType)
        {
            case E_World.In_World:

                // 2.通过鼠标，绘制连线，根据连线的提示判断是否可以附身
                DrawInfoLine();
                // 做附身后的事物独特的内容
                DoSpecialInteractInWorld();
                break;
            case E_World.Out_World:
                ClearInfoLine();
                DoSpecialInteractOutWorld();
                // 可以进行万向移动

                break;
        }
    }

    private void ClearInfoLine()
    {
        lineRenderer.startWidth = 0f;
        lineRenderer.endWidth = 0f;
    }

    /// <summary>
    /// 不同面具在Out_World的特殊交互
    /// </summary>
    private void DoSpecialInteractOutWorld()
    {
        switch (currentMaskData.maskType)
        {
            // 这三者都是行走
            case E_MaskType.Mouse:
            case E_MaskType.Wolf:
            case E_MaskType.Crocodile:
                break;
            case E_MaskType.Cassette:
                //保存游戏
                break;
            case E_MaskType.Crow:
            // 乌鸦的行为
            default:
                break;
        }
    }
    /// <summary>
    /// 不同面具在In_World的特殊交互
    /// </summary>
    private void DoSpecialInteractInWorld()
    {
        switch (currentMaskData.maskType)
        {
            case E_MaskType.Mask:
                break;
            // 这三者都是行走
            case E_MaskType.Mouse:
            case E_MaskType.Wolf:
            case E_MaskType.Crocodile:
                DoMove();
                CheckMoveMax();
                break;
            case E_MaskType.Cassette:
                //保存游戏
                if (!isSave)
                {
                    GameManager.Instance.SaveGame();
                    nowCrazyValue = 5;
                    isSave = true;
                }
                
                break;
            case E_MaskType.Crow:
                // 乌鸦的行为
                DoMove();
                break;
            //大象
            case E_MaskType.Elephant:
                DoMove();
                break;
            //球
            case E_MaskType.Ball:
                break;
            //巧克力
            case E_MaskType.Chocolate:
                CheckChocolateSp();
                break;
            //岩石
            case E_MaskType.Rock:
                break;
            case E_MaskType.Streetlight:
                CheckStreetlightSp();
                break;
        }
    }

    /// <summary>
    /// 根据鼠标右键的点击绘制线，计算消耗
    /// </summary>
    private void DrawInfoLine()
    {
        // if (Input.GetMosuseButton(1))
        // {
        // 1.直接到物品的位置进行附身
        Vector2 mousePos = Camera.main.ScreenToWorldPoint(Input.mousePosition);
        mousePos = HandleMousePos(mousePos);
        lastMousePos = mousePos;
        lineRenderer.SetPosition(0, transform.position);
        lineRenderer.SetPosition(1, mousePos);
        lineRenderer.startWidth = startWidth;
        lineRenderer.endWidth = endWidth;
        // 指向了自己
        if (GameManager.Instance.mapCell.CalGridDisByWorldPos(transform.position, mousePos) == 0)
        {
            Cursor.SetCursor(cursor0, Vector2.zero, CursorMode.Auto);
        }
        if (GameManager.Instance.mapCell.CalGridDisByWorldPos(transform.position, mousePos) <= 10 - nowCrazyValue)
        {
            lineRenderer.startColor = Color.green;
            lineRenderer.endColor = Color.green;
            Cell targetCell = GameManager.Instance.mapCell.WorldToCell(mousePos);
            if (targetCell.HasAbility())
            {
                lineRenderer.endColor = Color.yellow;
                Cursor.SetCursor(cursor2, Vector2.zero, CursorMode.Auto);
            }
            else
            {
                Cursor.SetCursor(cursor1, Vector2.zero, CursorMode.Auto);
            }
        }
        else
        {
            lineRenderer.startColor = Color.red;
            lineRenderer.endColor = Color.red;
        }
        // }
        // else if (Input.GetMouseButtonUp(1))
        // {
        //     lineRenderer.startWidth = 0f;
        //     lineRenderer.endWidth = 0f;
        // }
    }

    private Vector2 HandleMousePos(Vector2 mousePos)
    {
        if (mousePos.x < leftX)
        {
            mousePos.x = leftX;
        }
        else if (mousePos.x > rightX)
        {
            mousePos.x = rightX;
        }
        if (mousePos.y < bottomY)
        {
            mousePos.y = bottomY;
        }
        else if (mousePos.y > topY)
        {
            mousePos.y = topY;
        }
        return mousePos;
    }

    private void ChangeWorld()
    {
        // ResetStatus();
        switch (currentWorldType)
        {
            case E_World.In_World:
                GameManager.Instance.GoToOutWorld();
                grayPanel.Hide();
                targetCell = GameManager.Instance.mapCell.WorldToCell(lastMousePos);
                // 玩家在里世界指向面具 进行附身结算
                if (targetCell.HasAbility() && (targetCell.GetAbility() as Mask).abilityData.maskType != E_MaskType.Fence)
                {
                    this.GetAbility(targetCell.GetAbility().GetAbility());
                    //进行结算
                    CalculateEffectValue();
                    targetCell.ClearAbility();
                    //附身
                    this.AttachToOther(targetCell);
                }
                else
                {
                    grayPanel.gameObject.SetActive(true);
                    targetCell = null;
                    // 玩家在里世界移动，理智值结算
                    CalculateMoveValue();
                }
                
                break;
            case E_World.Out_World:
                grayPanel.Show();
                GameManager.Instance.GoToInWorld();
                break;
        }
    }

    private void DoMove()
    {
        if (startMovePos == Vector2.zero)
        {
            startMovePos = transform.position;
        }
        xInput = Input.GetAxisRaw("Horizontal");
        yInput = Input.GetAxisRaw("Vertical");
        if (xInput > 0 && this.transform.localScale == Vector3.one)
        {
            this.transform.localScale = new Vector3(-1, 1, 1);
        }
        else if (xInput < 0 && this.transform.localScale == new Vector3(-1, 1, 1))
        {
            this.transform.localScale = Vector3.one;
        }
        Vector2 moveDir = new Vector2(xInput, yInput).normalized;
        lastMovePos = transform.position;
        if (moveDir.magnitude > 0)
        {
            transform.Translate(moveDir * moveSpeed * Time.deltaTime);
        }
    }

    private void CheckMoveMax()
    {
        if (GameManager.Instance.mapCell.CalGridDisByWorldPos(startMovePos, transform.position) > nowReasonValue)
        {
            transform.position = lastMovePos;
        }
        if (GameManager.Instance.mapCell.WorldToCell(transform.position).HasAbility())
        {
            transform.position = lastMovePos;
        }
    }

    private void GetAbility(IAbility ability)
    {
        lastMaskData = currentMaskData;
        currentMaskData = ConfigManager.Instance.GetData<CfgMaskData>(ability.GetAbilityID());
        Destroy((ability as Mask).gameObject);
    }

    /// <summary>
    /// 计算这次附身的疯狂值和理智值结算
    /// </summary>
    /// <exception cref="NotImplementedException"></exception>
    private void CalculateEffectValue()
    {
        MapCell mapCell = GameManager.Instance.mapCell;
        Vector2 endPos = mapCell.CellToWorld(targetCell);
        int AddCrazyValue = mapCell.CalGridDisByWorldPos(startMovePos, endPos);
        Debug.Log($"AddCrazyValue:{AddCrazyValue}");
        int minusCrazyValue = Mathf.CeilToInt(Vector2.Distance(startMovePos, endPos));
        Debug.Log($"minusCrazyValue:{minusCrazyValue}");
        nowCrazyValue += AddCrazyValue - minusCrazyValue;
        nowReasonValue = currentMaskData.startLizi;
        CheckGameEnd();
    }

    private void CheckGameEnd()
    {
        if (nowCrazyValue >= 10 || nowCrazyValue <= 0)
        {
            // GameManager.Instance.GameEnd();
        }
    }

    /// <summary>
    /// 附身到其他面具
    /// </summary>
    /// <param name="targetCell"></param>
    /// <exception cref="NotImplementedException"></exception>
    private void AttachToOther(Cell targetCell)
    {
        //在原来的位置生成一个新的面具
        if (lastMaskData != null && lastMaskData.maskType != E_MaskType.Mask)
            GameManager.Instance.mapGenerate.SpawnItem(lastMaskData, transform.position);
        //更新位置
        transform.position = GameManager.Instance.mapCell.CellToWorldCenter(targetCell);
        //更新Sprite
        spriteRenderer.sprite = Resources.Load<Sprite>(currentMaskData.spritePath + "1");
        ResetStatus();
        Debug.Log($"path:{currentMaskData.spritePath + "1"}");
    }

    /// <summary>
    /// 重置参数
    /// </summary>
    public void ResetStatus()
    {
        startMovePos = Vector2.zero;
        lastMovePos = Vector2.zero;
        lastMousePos = Vector2.zero;
        targetCell = null;
        lastMaskData = null;
        hasTargetMaskInRange = false;
        isSave = false;
    }

    /// <summary>
    /// 检查一些巧克力的特殊行为
    /// </summary>
    public void CheckChocolateSp()
    {
        // if(mouseMasks == null || mouseMasks.Count == 0)
        // {
        //     //进行范围检测
        //     //获取所有的老鼠面具
        //     mouseMasks = new List<Mask>();
        if(hasTargetMaskInRange) return;
        Collider2D[] colliders = Physics2D.OverlapCircleAll(transform.position, currentMaskData.checkDis, 1 << LayerMask.NameToLayer("Mask"));
        if (colliders.Length > 0)
        {
            foreach (var collider in colliders)
            {
                Mask mask = collider.GetComponent<Mask>();
                if (mask != null)
                {
                    hasTargetMaskInRange = true;
                    switch (mask.abilityData.maskType)
                    {
                        case E_MaskType.Mouse:
                            mask.StartCoroutine(mask.MoveToTargetPos(transform.position));
                            break;
                        case E_MaskType.Wolf:
                            Debug.Log("驱逐狼");
                            mask.StartCoroutine(mask.AwayToTarget(transform.position, currentMaskData.checkDis));
                            break;

                    }
                }
            }
        }
        // }
    }

    /// <summary>
    /// 检查一些街道灯的特殊行为
    /// </summary>
    public void CheckStreetlightSp()
    {
        if(hasTargetMaskInRange) return;
        Collider2D[] colliders = Physics2D.OverlapCircleAll(transform.position, currentMaskData.checkDis, 1 << LayerMask.NameToLayer("Mask"));
        if (colliders.Length > 0)
        {
            foreach (var collider in colliders)
            {
                Mask mask = collider.GetComponent<Mask>();
                if (mask != null)
                {
                    hasTargetMaskInRange = true;
                    switch (mask.abilityData.maskType)
                    {
                        case E_MaskType.Crow:
                            mask.StartCoroutine(mask.MoveToTargetPos(transform.position));
                            break;
                        case E_MaskType.Mouse:
                            mask.StartCoroutine(mask.AwayToTarget(transform.position, currentMaskData.checkDis));
                            break;

                    }
                }
            }
        }
        // }
    }

    public void CalculateMoveValue()
    {
        // 玩家在里世界移动，机型理智值计算
        int minusReasonValue = Mathf.FloorToInt(Vector2.Distance(startMovePos, transform.position));
        nowReasonValue -= minusReasonValue;
        startMovePos = transform.position;
    }

    public void PauseGame()
    {
        isPause = true;
    }

    public void RestoreGame()
    {
        isPause = false;
    }
}